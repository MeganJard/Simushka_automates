# Скрипты системы (Актуально на апрель 2025)

Для корректной работы системы необходимо запустить следующие скрипты:

- `scheduler`
- `scheduler2`
- `bitrix_update_min`

---

## Скрипты, запускаемые `scheduler`

### 1. `fastapi_add_markup_to_deals`
Отправляет POST-запрос к API для установки меток в сделках по заданным параметрам лидов.  
Использует фильтрацию по ID и пользовательским полям.

---

### 2. `cdeck_update`
Авторизуется в личном кабинете СДЭК, выгружает заказы за указанный период.  
Обрабатывает данные (включая JSON-поля) и сохраняет в таблицы:

- `cdek_orders`
- `cdek_packages`

---

### 3. `users_from_redhare`
Загружает JSON с данными пользователей с сайта, сортирует по дате создания.  
Сохраняет результат в таблицу:

- `users_from_redhare`

---

### 4. `plytix_rhm_aviability`
Получает токен доступа и выгружает данные о продуктах из API Plytix.  
Структурирует категории, объединяет с таблицей семейств и сохраняет в:

- `plytix_products`

---

### 5. `bitrix_goods`
Асинхронно загружает сделки и связанные товары из Bitrix24.  
Преобразует нестандартные поля и сохраняет в таблицы:

- `bitrix_deals_w_all_fields`
- `bitrix_deals_goods`

---

### 6. `bitrix_to_sql`
Анализирует продолжительность сделок в каждом статусе Bitrix24.  
Сохраняет результаты в CSV-файл и обновляет данные по звонкам и дополнительным полям.

---

### 7. `loyalty_cards`
Собирает данные о клиентах и бонусных картах из API Yclients (по филиалам).  
Объединяет информацию и сохраняет в таблицу:

- `joined_loyalty_cards`

---

### 8. `historical_title`
Анализирует записи клиентов и оказанные услуги в Yclients.  
Определяет и восстанавливает историю должностей сотрудников по дням.  
Сохраняет результат в таблицу:

- `joined_historical_title`

---

### 9. `bitrix_jardi_job`
Поочерёдно запрашивает лиды из Bitrix24 с начала 2024 года.  
Извлекает поле `UF_CRM_1717750279233`, объединяет данные и сохраняет в:

- `additional lead data`

---

## Скрипты, запускаемые `scheduler2`

### 1. `persona_data`
Собирает и обрабатывает данные из Yclients (записи, товары, транзакции, лояльность).  
Рассчитывает зарплату мастеров с учётом множества факторов и формирует отчёты по дням, сменам и месяцам.  
Сохраняет в SQL-таблицы для отчётов Power BI.

---

### 2. `persona_export`
Выгружает данные из таблицы `Persona_Zpl_Last_Day_test` по сотрудникам.  
Группирует по месяцам и обновляет персональные Google-таблицы.  
Создаёт новые таблицы при необходимости.

---

### 3. `JOINED`
Собирает данные из Yclients API (персонал, записи, продажи, расписания и т.д.).  
Загружает их в таблицы MS SQL Server для автоматического обновления аналитической базы по филиалам.

---

### 4. `reviews_google_sheets_to_sql`
Извлекает отзывы и прогнозы продаж из Google Sheets.  
Обрабатывает данные в `pandas` и загружает в SQL Server.  
Обновляет таблицы:

- `joined_reviews`
- `ОИМ_прогнозы`

---

### 5. `lost_clients`
Анализирует данные посещений, выявляет "потерянных" клиентов и создаёт для них лиды в Bitrix24.  
Сохраняет данные о лидах и обновляет список в CSV-файл.

---

### 6. `loyalty_new`
Загружает детализированные данные о лояльности клиентов из API Yclients (услуги и товары) за 2023–2024 гг.  
Сохраняет в таблицу:

- `joined_loyalty_new`

---

## Скрипт `bitrix_update_min`

### Описание
Отдельный скрипт, запускающий бесконечный цикл с обновлением сделок и лидов в Bitrix24 каждые 15 минут.  
Использует функции:

- `update_bitrix_leads()`
- `update_bitrix_deals()`
